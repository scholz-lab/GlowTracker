#:kivy 2.0
#:import NumericProperty kivy.properties.NumericProperty
#: import partial functools
# main Window has 3 columns
# left most is settings  and setting displays
# middle is the image window
# right most is opening dialogs



MainWindow:
    size: root.size
    pos: root.pos
    id: maingrid
    cols: 3
    rows: 2
    padding: [10,10,10,10]
    spacing: 10
    MyLogo:
        size_hint: (0.3, 0.15)
    MyLabel:
        id: title
        text: 'Macroscope GUI'
        font_size: 42
        size_hint: (0.6, 0.15)
    MyLabel:
        size_hint: (0.1,0.15)
    LeftColumn:
        id: leftcolumn
    MiddleColumn:
        id: middlecolumn
    RightColumn:
        id: rightcolumn

# popup confirming closing
<ExitApp>:
    BoxLayout:
        size_hint_y: None
        height: 30
        Button:
            text: "Cancel"
            on_release: root.cancel()

        Button:
            text: "Close"
            on_release: root.stop()

#################################
# Left column
#################################
<LeftColumn>:
    size_hint: (0.3,1)
    orientation: 'vertical'
    pos: root.pos
    spacing: 5
    MyLabel: 
        text: 'Stage Controls'
    XControls:
    YControls:
    ZControls:
    MyButton:
        text: 'Autofocus'
        pos_hint: {'x': 0.25}
    MyLabel: 
        text: 'Camera Settings'
    CameraProperties:
        id: camprops
        size_hint: (1, 1.75)
    MyButton:
        text: 'Load camera settings'
        pos_hint: {'x': 0.25}
        on_release: root.show_load()
        
    MyLabel: 
        text: 'Experiment'
    TextInput:
        id: saveloc
        size_hint_y: None
        height: 30
        multiline: False
        text: "Startup"
    MyButton:
        text: 'Save Location'
        pos_hint: {'x': 0.25}
        on_release: root.show_save()
    
        
        

### Display camera properties

<CameraProperties>:
    gain: gain
    exposure: exposure
    framerate: framerate
    cols: 3
    rows: 3
    Label:
        text: 'Exposure (us)'
        size_hint: (.25, 1)
    Slider:
        id: exposure
        size_hint: (.5, 1)
        min: 100
        max: 100000
        step: 100
        on_value: root.change_exposure()
    TextInput:
        id: exposuretext
        size_hint: (.25, 1)
        text: str(exposure.value)
    Label: 
        text: 'Framerate (fps)'
        size_hint: (.25, 1)
    Slider:
        id: framerate
        size_hint: (.5, 1)
        min: 0.01
        max: 57
        step: 0.5
        on_value: root.change_framerate()
    TextInput:
        id: frameratetext
        size_hint: (.25, 1)
        text: str(round(framerate.value, 2))
    Label:
        text: 'Gain'
        size_hint: (.25, 1)
    Slider:
        id: gain
        size_hint: (.5, 1)
        min: 0
        max: 36
        step: 0.5
        on_value: root.change_gain()
    TextInput:
        id: gaintext
        size_hint: (.25, 1)
        text: str(gain.value)
    
        
        

    
#################################
# Stage motion buttons
#################################

<StageButtonLeftFast@Button>:
    size_hint: .5, .9
    pos_hint: {"x":0.1, "y":0.1}
    background_normal: 'icons/LeftButtonNormal_Double.jpg'
    background_down: 'icons/LeftButtonOnPress_Double.jpg'
    
<StageButtonLeft@Button>:
    size_hint: .25, .9
    pos_hint: {"x":0.1, "y":0.1}
    background_normal: 'icons/LeftButtonNormal.jpg'
    background_down: 'icons/LeftButtonOnPress.jpg'
    
<StageButtonRightFast@Button>:
    size_hint: .5, .9
    pos_hint: {"x":0.1, "y":0.1}
    background_normal: 'icons/RightButtonNormal_Double.jpg'
    background_down: 'icons/RightButtonOnPress_Double.jpg'
    
<StageButtonRight@Button>:
    size_hint: .25, .9
    pos_hint: {"x":0.1, "y":0.1}
    background_normal: 'icons/RightButtonNormal.jpg'
    background_down: 'icons/RightButtonOnPress.jpg'

<XControls>:
    BoxLayout:
        orientation: 'horizontal'
        size: root.size
        pos: root.pos
        StageButtonLeftFast:            
            on_press: app.stage.move_rel((-50,0,0), unit = 'um')
        StageButtonLeft:
            on_press: app.stage.move_rel((-20,0,0), unit = 'um')
        Label:
            text: 'X'
            font_size: 40
            size_hint: (0.2,1)
        StageButtonRight:
            on_press: app.stage.move_rel((20,0,0), unit = 'um')
        StageButtonRightFast:            
            on_press: app.stage.move_rel((50,0,0), unit = 'um')

<YControls>:
    BoxLayout:
        orientation: 'horizontal'
        size: root.size
        pos: root.pos
        StageButtonLeftFast:            
            on_press: app.stage.move_rel((0,-500,0), unit = 'um')
        StageButtonLeft:
            on_press: app.stage.move_rel((0,-200,0), unit = 'um')
        Label:
            text: 'Y'
            valign: 'bottom'
            font_size: 40
            size_hint: (0.2,1)
        StageButtonRight:
            on_press: app.stage.move_rel((0,200,0), unit = 'um')
        StageButtonRightFast:            
            on_press: app.stage.move_rel((0,500,0), unit = 'um')
            
            
<ZControls>:
    BoxLayout:
        orientation: 'horizontal'
        size: root.size
        pos: root.pos
        StageButtonLeftFast:            
            on_press: app.stage.move_rel((0,0,-500), unit = 'um')
        StageButtonLeft:
            on_press: app.stage.move_rel((0,0,-200), unit = 'um')
        Label:
            text: 'Z'
            font_size: 40
            size_hint: (0.2,1)
        StageButtonRight:
            on_press: app.stage.move_rel((0,200,0), unit = 'um')
        StageButtonRightFast:            
            on_press: app.stage.move_rel((0,500,0), unit = 'um')

#################################
# Load camera properties - Popup
#################################
<LoadCameraProperties>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser2
            path: ''
            filters: ['*.pfs']

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Load"
                on_release: root.load(filechooser2.path, filechooser2.selection)
                
#################################
# save location experiment - Popup
#################################
<SaveExperiment>:
    rows: 2
    cols:1
    text_input: text_input
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            dirselect: True
            path: '/home'
            on_selection: text_input.text = self.selection and self.selection[0] or ''
        TextInput:
            id: text_input
            size_hint_y: None
            height: 30
            multiline: False

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()

            Button:
                text: "Save"
                on_release: root.save(filechooser.path, text_input.text)        

            
            
#################################
# Middle column
#################################
<MiddleColumn>:
    id: middlecolumn
    runtimecontrols:runtimecontrols
    previewimage:previewimage
    size: root.size
    pos: root.pos
    size_hint: (0.6,1)
    GridLayout:
        cols: 1
        rows: 2
        PreviewImage:
            id: previewimage
        RuntimeControls:
            id:runtimecontrols
        
### live camera image
<PreviewImage>:
    size_hint: (0.6, 0.85)
    

### toggle tracking or autofocus
<RuntimeControls>:
    framecounter: framecounter
    size_hint: (0.6,0.15)
    RecordButtons:
        id: recordbuttons
    GridLayout:
        cols: 2
        rows: 3
        MyLabel:
            text: 'Frames'
            color: '#ffffff'
        MyCounter:
            id: framecounter
            color: '#ffffff'
            text: str(self.value)
        MyLabel:
            text: 'Autofocus'
            color: '#ffffff'
        CheckBox:
        MyLabel:
            text: 'Tracking'
            color: '#ffffff'
        CheckBox:



### Live view and Record
<RecordButtons>:
    orientation: 'horizontal'
    spacing: 30
    padding: [80,10]
    recordbutton:recordbutton
    iveviewbutton:liveviewbutton
    ToggleButton:
        id: liveviewbutton
        border: 0,0,0,0
        size_hint_x: 0.1
        size_hint_y: None
        height: self.width 
        pos_hint: {'center_x': .5, 'center_y': .5}
        background_normal: 'icons/play_off.png'
        background_down: 'icons/play_on.png'
        background_disabled_normal: 'icons/play_disabled.png'
        on_state: root.startPreview() if self.state=='down' else root.stopPreview()
        disabled: recordbutton.state =='down'
    ToggleButton: 
        id: recordbutton
        border: 0,0,0,0
        size_hint_x: 0.1
        size_hint_y: None
        height: self.width 
        pos_hint: {'center_x': .5, 'center_y': .5}
        background_normal: 'icons/record_inactive.png'
        background_down: 'icons/record_active.png'
        on_state: root.startRecording() if self.state=='down' else root.stopRecording()

#################################
# Right column
#################################
<RightColumn>:
    size: root.size
    pos: root.pos
    orientation: "vertical"
    size_hint: (0.1, 1)
    MyLabel:
        text: 'Settings'
        size_hint: (1, 0.1)
    MyButton:
        size_hint: (1, 0.1)
        text: 'Camera'
    MyButton: 
        id:recording
        size_hint: (1, 0.1)
        text: 'Recording'
        on_release: root.show_recording_settings()
    MyButton:
        size_hint: (1, 0.1)
        text: 'Stage'
    MyButton:
        size_hint: (1, 0.1)
        text: 'LEDs'
    MyLabel:
        text: 'Hardware'
        size_hint: (1, 0.1)
    Connections:
        id: connections 
        size_hint: (1,0.2)
 
### Popup recording Settings
<RecordingSettings>:
    size: root.size
    pos: root.pos
    orientation: 'vertical'
    
    frames: frames
    framerate : framerate
    fileformat : fileformat
    GridLayout:
        cols : 2
        Label: 
            text: 'Frames'
        TextInput:
            id: frames
            text: root.frames
        Label: 
            text: 'Framerate'
        Label:
            id: framerate
            text: root.framerate
        Label: 
            text: 'Filetype'
        Label:
            id: fileformat
            text: root.fileformat
    BoxLayout:
        size_hint_y: None
        height: 30
        Button:
            text: "Cancel"
            on_release: root.cancel()

        Button:
            text: "Confirm"
            on_release: root.update(frames.text)

### display if hardware is connected successfully     
<Connections>:
    orientation: 'vertical'
    size_hint: (0.3, 1)
    cam_connection: cam_connection
    stage_connection: stage_connection
    Label:
        text: 'Camera'
        size_hint: (1,0.5)
    OnOffButton:
        id: cam_connection
        border: 0,0,0,0
        size_hint_x: 0.3
        size_hint_y: None
        height: self.width 
        pos_hint: {'center_x': .5, 'center_y': .5}
        background_normal: 'icons/connection_off.png'
        background_down: 'icons/connection_on.png'
        on_state: root.connectCamera() if self.state=='down' else root.disconnectCamera()
    Label:
        text: 'Stage'
        size_hint: (1,0.5)
    OnOffButton:
        id: stage_connection 
        border: 0,0,0,0
        size_hint_x: 0.3
        size_hint_y: None
        height: self.width 
        pos_hint: {'center_x': .5, 'center_y': .5}
        background_normal: 'icons/connection_off.png'
        background_down: 'icons/connection_on.png'
        on_state: root.connectStage() if self.state=='down' else root.disconnectStage()
    
        
      
#################################
# Layout settings - custom
#################################
<MyButton@Button>:
    #size: self.texture_size
    size_hint: (0.5, 0.5)
    font_size: 18
    halign: 'center'
    

<MyLabel@Label>:
    #size: self.texture_size
    size_hint: (1, 1)
    font_size: 18
    halign: 'center'
    color: '#8e0045ff'
    
    
<MyLogo@Image>:
    keep_ratio: True
    source: 'icons/logoSq.png'
    spacing: -10
    border: 0,0,0,0
    

<OnOffButton@ToggleButton>  
    background_normal: 'icons/connection_off.png'
    background_down: 'icons/connection_on.png'
    
<MyCounter@Label>:
    value: 0


